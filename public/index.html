<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="/favicon.png" type="image/png">
  <title>é¢œå€¼æ‰“åˆ†æœº ğŸ˜»</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer onload="initTurnstile()"></script>
</head>

<body>
  <div class="container">
    <h1>é¢œå€¼æ‰“åˆ†æœº âœ¨</h1>
    <p>ä¸Šä¼ ä¸€å¼ ç…§ç‰‡ï¼Œè®© AI çŒ«çŒ«å¸®ä½ è¯„åˆ†å§ï½</p>

    <div class="file-upload-wrapper">
      <input type="file" id="fileInput" accept="image/*" />
      <label for="fileInput" class="file-upload-label" id="uploadLabel">
        <div class="upload-placeholder">
          <svg class="file-upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
            </path>
          </svg>
          <span class="file-upload-text">ç‚¹å‡»é€‰æ‹©ç…§ç‰‡</span>
        </div>
        <img id="preview" class="upload-preview" alt="Preview" />
      </label>
    </div>

    <div class="turnstile-container">
      <div id="turnstile-widget" data-theme="light"></div>
    </div>

    <button id="submitBtn">å¼€å§‹è¯„åˆ†</button>

    <div id="result"></div>

    <button id="imagesBtn" class="secondary-btn" style="display: none;">æµè§ˆæ‰€æœ‰é¢œå€¼ç…§ç‰‡</button>
    <button id="logoutBtn" class="secondary-btn" onclick="handleLogout()" style="display: none;">é€€å‡ºç™»å½•</button>
  </div>

  <script>
    // æ–‡ä»¶é€‰æ‹©åç«‹å³é¢„è§ˆ
    document.getElementById("fileInput").onchange = function () {
      const fileInput = this;
      const previewImg = document.getElementById("preview");
      const uploadLabel = document.getElementById("uploadLabel");

      if (!fileInput.files.length) {
        previewImg.classList.remove("show");
        uploadLabel.classList.remove("has-image");
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function () {
        previewImg.src = reader.result;
        previewImg.classList.add("show");
        uploadLabel.classList.add("has-image");
      };
      reader.readAsDataURL(file);
    };

    // Turnstile çŠ¶æ€æ ‡è®°ï¼ˆæœªé…ç½®åˆ™è·³è¿‡ï¼‰
    let turnstileEnabled = false;

    // åŠ¨æ€åˆå§‹åŒ– Turnstile ç»„ä»¶ï¼Œè‹¥æœªé…ç½®åˆ™éšè—æ§ä»¶
    async function initTurnstile() {
      // ç¡®ä¿ DOM å®Œå…¨åŠ è½½
      if (document.readyState !== 'complete') {
        document.addEventListener('DOMContentLoaded', initTurnstile);
        return;
      }
      
      const widgetContainer = document.querySelector('.turnstile-container');
      try {
        const res = await fetch('/api/turnstile');
        const data = await res.json();

        if (data.site_key && typeof data.site_key === 'string' && data.site_key.trim()) {
          turnstileEnabled = true;
          // ä½¿ç”¨è·å–åˆ°çš„ç«™ç‚¹å¯†é’¥åˆå§‹åŒ– Turnstile ç»„ä»¶
          turnstile.render('#turnstile-widget', {
            sitekey: data.site_key,
            theme: 'light'
          });
        } else {
          turnstileEnabled = false;
          console.warn('Turnstile site key not configured, skip captcha');
          if (widgetContainer) widgetContainer.style.display = 'none';
        }
      } catch (error) {
        turnstileEnabled = false;
        console.error('Failed to initialize Turnstile, skip captcha:', error);
        if (widgetContainer) widgetContainer.style.display = 'none';
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    document.addEventListener('DOMContentLoaded', () => {
      // æ·»åŠ æŸ¥çœ‹æ‰€æœ‰å›¾ç‰‡æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
      const imagesBtn = document.getElementById('imagesBtn');
      if (imagesBtn) {
        imagesBtn.addEventListener('click', () => {
          window.location.href = '/images';
        });
      }

      // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶æ˜¾ç¤ºç›¸åº”æŒ‰é’®
      async function checkLoginStatus() {
        try {
          const response = await fetch('/api/auth', { credentials: 'include' });
          const data = await response.json();

          const logoutBtn = document.getElementById('logoutBtn');
          const imagesBtn = document.getElementById('imagesBtn');

          if (data.success) {
            // å·²ç™»å½•ï¼Œæ˜¾ç¤ºç™»å‡ºå’Œå›¾ç‰‡æŒ‰é’®ï¼Œéšè—ç™»å½•æŒ‰é’®
            logoutBtn.style.display = 'block';
            imagesBtn.style.display = 'block';
          } else {
            // æœªç™»å½•ï¼Œéšè—ç®¡ç†å…¥å£æŒ‰é’®ï¼Œä»…ä¿ç•™åé—¨è§¦å‘
            logoutBtn.style.display = 'none';
            imagesBtn.style.display = 'none';
          }
        } catch (error) {
          console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
          // å‡ºé”™æ—¶éšè—æ‰€æœ‰æŒ‰é’®
          document.getElementById('logoutBtn').style.display = 'none';
          document.getElementById('imagesBtn').style.display = 'none';
        }
      }

      // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
      checkLoginStatus();
    });

    // ç™»å‡ºå‡½æ•°
    async function handleLogout() {
      try {
        await fetch('/api/auth', {
          method: 'DELETE',
          credentials: 'include'
        });
        // ç™»å‡ºæˆåŠŸï¼Œåˆ·æ–°é¡µé¢
        window.location.reload();
      } catch (error) {
        console.error('ç™»å‡ºå¤±è´¥:', error);
        alert('ç™»å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    // æ ‡é¢˜ç‚¹å‡»è®¡æ•°å™¨
    let clickCount = 0;
    const titleElement = document.querySelector('h1');

    // ç‚¹å‡»äº‹ä»¶å¤„ç†
    if (titleElement) {
      titleElement.addEventListener('click', async () => {
        clickCount++;

        // ç‚¹å‡»5æ¬¡è§¦å‘åé—¨
        if (clickCount === 5) {
          try {
            const response = await fetch('/api/auth', { credentials: 'include' });
            const data = await response.json();

            if (data.success) {
              // å·²ç™»å½•æˆ–åé—¨å¼€å¯ï¼Œç›´æ¥è¿›å…¥å›¾ç‰‡åˆ—è¡¨
              window.location.href = '/images';
            } else {
              // æœªç™»å½•ï¼Œè·³è½¬åˆ°GitHubç™»å½•
              window.location.href = '/api/auth/github';
            }
          } catch (error) {
            console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            // å‡ºé”™æ—¶ç›´æ¥è·³è½¬åˆ°ç™»å½•
            window.location.href = '/api/auth/github';
          }

          // é‡ç½®è®¡æ•°å™¨
          clickCount = 0;
        }
      });
    }

    document.getElementById("submitBtn").onclick = async function () {
      const fileInput = document.getElementById("fileInput");
      if (!fileInput.files.length) {
        alert("å–µï½å…ˆé€‰å¼ ç…§ç‰‡æ‰èƒ½è¯„åˆ†å“¦ï¼");
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = async function () {
        const base64 = reader.result.split(",")[1];
        const resultDiv = document.getElementById("result");
        resultDiv.innerText = "è¯„åˆ†ä¸­ï¼ŒçŒ«çŒ«æ­£åœ¨è®¤çœŸåˆ†æä¸­å–µ...";

        try {
          // è·å– Turnstile å“åº”ä»¤ç‰Œï¼ˆä»…å½“å¯ç”¨ä¸”ç»„ä»¶å¯ç”¨ï¼‰
          let token = null;
          if (turnstileEnabled && typeof turnstile !== 'undefined' && typeof turnstile.getResponse === 'function') {
            token = turnstile.getResponse();
            if (!token) {
              resultDiv.innerText = "éªŒè¯å¤±è´¥ï¼Œè¯·å®ŒæˆéªŒè¯ç å–µï½";
              return;
            }
          }

          const res = await fetch("/api/score", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              image: base64,
              // ä»…åœ¨å¯ç”¨æ—¶æºå¸¦ Turnstile token
              ...(token ? { turnstile_response: token } : {})
            }),
          });
          if (!res.ok) throw new Error("æ¥å£è¯·æ±‚å¤±è´¥å–µï½");
          const data = await res.json();

          if (data.score !== undefined && data.score !== null) {
            const score = Number(data.score.toFixed(1));
            let msg = `é¢œå€¼åˆ†æ•°ï¼š${score} / 100 ğŸ¾\n\n`;

            // ğŸ’¬ å¦‚æœåç«¯è¿”å›äº† AI ç”Ÿæˆçš„ç‚¹è¯„ï¼Œå°±ä¼˜å…ˆæ˜¾ç¤º
            if (data.comment) {
              msg += `çŒ«çŒ«ç‚¹è¯„ï¼š${data.comment}\n\n`;
            } else {
              // åç«¯æ²¡è¿”å› AI æ–‡æ¡ˆï¼Œå°±èµ°æœ¬åœ°é€»è¾‘å…œåº•
              if (score < 40) {
                msg += "ğŸ± å–µå‘œï¼Œå†…åœ¨ç¾æ‰æ˜¯æœ€æœ€é‡è¦çš„ï¼æŠ±æŠ±ï½";
              } else if (score < 50) {
                msg += "ğŸ’« ä½ æœ‰é‚£ç§æ²»æ„ˆç³»çš„å¯çˆ±æ°”è´¨ï¼Œæ…¢æ…¢å±•ç°æ›´è¿·äººå–µï½";
              } else if (score < 60) {
                msg += "âœ¨ ä¸­ç­‰é¢œå€¼ï¼Œä½†æœ‰ç‰¹åˆ«çš„å°é—ªå…‰ç‚¹ï¼Œè¶Šçœ‹è¶Šèˆ’æœï½";
              } else if (score < 70) {
                msg += "ğŸ˜» å“‡ï¼Œå·²ç»å¾ˆæœ‰å¸å¼•åŠ›å•¦ï¼Œæœ‰ç‚¹æ˜æ˜Ÿæ°”åœºå‘¢ï¼";
              } else if (score < 80) {
                msg += "ğŸŒŸ è¶…æ£’ï¼ä½ èµ°åœ¨è¡—ä¸Šç»å¯¹æ˜¯å›å¤´ç‡è¶…é«˜çš„å°çŒ«çŒ«ï¼";
              } else {
                msg += "ğŸ”¥ ç»ç»å­ï¼ä½ çš„é¢œå€¼çªç ´å¤©é™…ï¼ŒçŒ«çŒ«éƒ½è¦å°–å«å•¦ï¼";
              }
            }

            resultDiv.innerText = msg;
          } else {
            resultDiv.innerText = "æ£€æµ‹å¤±è´¥ï¼Œå–µå‘œï½æ¢å¼ æ›´æ¸…æ™°çš„ç…§ç‰‡è¯•è¯•å§ï¼Ÿ";
          }
        } catch (e) {
          resultDiv.innerText = "å‡ºé”™äº†å–µï½è¯·ç¨åå†è¯•ä¸€ä¸‹ï¼";
          console.error("è¯„åˆ†è¯·æ±‚é”™è¯¯:", e);
        }
      };
      reader.readAsDataURL(file);
    };
  </script>
</body>

</html>